name: AWS SAM CI/CD Pipeline

on:
  push:
    branches:
      - main  # Trigger on push to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull request to the main branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.11'  # Use the appropriate version of Python

    - name: Install AWS SAM CLI
      run: |
        curl -sSL https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip -o sam-cli.zip
        unzip sam-cli.zip -d sam-cli
        sudo ./sam-cli/install

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r lambda_functions/aggregator/requirements.txt  
    
    - name: Build the AWS SAM project
      run: |
        cd lambda/aggregator  
        sam build

    - name: Validate SAM template
      run: |
        cd lambda_functions/aggregator  
        sam validate --lint

    - name: Run unit tests for Lambda function
      run: |
        cd lambda_functions/aggregator             
        python -m unittest tests/test_aggregation.py


